[К списку вопросов](db_exam.md)

# 3. Нормализация отношений. Концепция нормальных форм. Декомпозиция без потерь и функциональные зависимости. Первая, вторая и третья нормальные формы. Нормальная форма Бойса-Кодда.

**Нормализация отношений БД** – это процесс их преобразования к виду, отвечающему нормальным формам.
Классический подход к проектированию реляционных баз данных заключается в том, что сначала предметная область представляется в виде одного или нескольких отношений, а далее осуществляется процесс нормализации схем отношений, причем каждая следующая нормальная форма обладает свойствами лучшими, чем предыдущая.
 
**Нормальные формы:**
* первая нормальная форма (1НФ или 1NF) *все атрибуты простые*
* вторая нормальная форма (2НФ или 2NF) *не ключевые атрибуты зависят от ПК*
* третья нормальная форма (3НФ или 3NF) *не ключевые атрибуты не транзитивно зависят от ПК*
* нормальная форма Бойса-Кодда (НФБК или BCNF) *каждый детерминант является потенциальным ключом*
* четвёртая нормальная форма (4НФ или 4NF) *все нетривиальные многозначные зависимости фактически являются функциональными зависимостями от ее потенциальных ключей*
* пятая нормальная форма или нормальная форма проекции-соединения (5НФ или 5NF или PJ/NF) *отсутствуют сложные зависимые соединения между атрибутами*
 
**Свойства** нормальных форм:
* каждая следующая НФ «лучше» предыдущей
* при переходе к следующей НФ свойства предыдущих нормальных свойств сохраняются
* переход к следующей НФ обратим
* переход к следующей НФ происходит без потери, появления и искажения данных
* переход к следующей НФ происходит за счёт декомпозиции отношений на два или более отношений
 
**Цели** нормальных форм:
* исключение некоторых типов избыточности
* устранение некоторых аномалий обновления
Цели актуальны для OLTP (обработка транзакций в реальном времени), но не актуальны для OLAP (интерактивная аналитическая обработка).
 
**Функциональные зависимости**
 
<u>Определение 1:</u>

Пусть R – это отношение, а X и Y – произвольные подмножества множества атрибутов отношения R. Тогда Y функционально зависимо от X ↔ Ɐ значение множества X связано в точности с одним значением множества Y.

Символическая запись: X -> Y

Левая часть – детерминант, правая – зависимая часть.

↔ – тогда и только тогда, когда

Ɐ – все

-> – если X верно, то Y также верно

Пример:

![](imgs/img_2.png)

<u>Определение 2:</u>

Пусть R является переменной-отношением, а X и Y – произвольными подмножествами множества атрибутов переменной-отношения R. Тогда X -> Y ↔ для Ɐ допустимого значения отношения R Ɐ значение X связано в точности с одним значением Y.

<u>Определение 2a:</u>

Пусть R(A1, A2, …, An) – схема отношения. Функциональная зависимость X -> Y между двумя наборами атрибутов X и Y, которые являются подмножествами R определяет ограничение на возможность существования кортежа в некотором отношении r. Ограничение означает, что для любых двух кортежей t1 и t2 в r, для которых имеет место t1[X] = t2[X], также имеет место t1[Y] = t2[Y].

 * Если ограничение на схеме отношения R утверждает, что не может быть более одного кортежа со значением атрибутов X в любом отношении экземпляре отношения r, то X является потенциальным ключом R. Это означает, что X -> Y для любого подмножества атрибутов Y из R. Если X является потенциальным ключом R, то X -> R
 * Если X -> Y в R, это не означает, что Y -> X в R.
 * Если переменная-отношение R удовлетворяет ФЗ X -> Y и X не является потенциальным ключом, то R будет характеризоваться некоторой избыточностью (в SCP – сведения о том, что каждый данный поставщик находится в данном городе)
 * Избыточность приводит к аномалиям обновления[^1]

Определение (**тривиальные зависимости**): \
ФЗ (X -> Y) тривиальная ↔ Y ⊆ X. \
⊆ - подмножество

## 1 нормальная форма
 
**Определение:**
Переменная отношения находится в 1НФ тогда и только тогда, когда в любом допустимом значении отношения каждый его кортеж содержит только одно значение для каждого из атрибутов (то есть атомарно).
Первая нормальная форма - это условие, согласно которому каждый компонент каждого кортежа является атомарным значением. В реляционной модели отношение всегда находится в первой нормальной форме по определению понятия отношение.
 
![](imgs/3_1.png)
 
## 2 нормальная форма
 
**Определение 1** (В этом определении предполагается, что единственным ключом отношения является первичный ключ):
Отношение R находится во 2НФ в том и только в том случае, когда оно находится в 1НФ , и каждый неключевой атрибут полностью зависит от первичного ключа.
 
**Определение 2:**
Отношение R находится во 2НФ в том и только в том случае, когда он находится в 1НФ, и каждый неключевой атрибут полностью зависит от каждого ключа R.
 
![](imgs/3_2.png)
 
## 3 нормальная форма
 
**Определение** (Снова определение дается в предположении существования единственного ключа.):
Отношение R находится в 3НФ тогда и только тогда, когда оно находится в 2НФ и ни один неключевой атрибут отношения не находится в транзитивной функциональной зависимости (когда X функционально зависит от Y, а Y от Z, то есть Х транзитивно зависит от Z) от потенциального ключа отношения.
 
![](imgs/3_3.png)
 
Определение 3НФ неадекватно при выполнении следующих условий:
 * переменная-отношение имеет два (или более потенциальных ключа
 * эти потенциальные ключи являются составными
 * два или более потенциальных ключей перекрываются (т.е. имеют по крайней мере один общий атрибут)


## Нормальная форма Бойса-Кодда
 
**Детерминант** – любой атрибут (или группа атрибутов), от которого полностью функционально зависит некоторый другой атрибут.
 
**Определение:**
Отношение R находится в НФБК в том и только в том случае, если каждый детерминант является потенциальным ключом.
 
* позволяет устранить все аномалии обновления, связанные с ФЗ (если какие-то атрибуты функционально зависят от каких-то других атрибутов, и при их редактировании-удалении возникают какие-то аномалии)
* не избавляет от аномалий обновления, связанных с наличием многозначных зависимостей.
 
![](imgs/3_4.png)
 
Процедура нормализации

1. Переменную-отношение в 1НФ следует разбить на такие проекции, которые позволят исключить все функциональные зависимости, не являющиеся неприводимыми. В результате будет получен набор переменных-отношений в 2НФ.
2. Полученные переменные-отношения в 2НФ следует разбить на такие проекции, которые позволят исключить все существующие транзитивные функциональные зависимости. В результате будет получен набор переменных-отношений в 3НФ.
3. Полученные переменные-отношения в 3НФ следует разбить на проекции, позволяющие исключить любые оставшиеся функциональные зависимости, в которых детерминанты не являются потенциальными ключами. В результате такого приведения будет получен набор переменных-отношений в НФБК.

<u>Замечание.</u> Правила 1-3 могут быть объединены в одно: "Исходную переменную-отношение следует разбить на проекции, позволяющие исключить все функциональные зависимости, в которых детерминанты не являются потенциальными ключами".


## Пример преобразования R к BCNF
 
Дано отношение R(A, B, (C, D, (E, F, G, H, I))) и множество ФЗ.
 
A -> B, \
E -> FG, \
G -> H, \
ACE -> I, \
AC -> D, \
D -> C \
}
 
1NF – Удаляем повторяющиеся группы. Жирным выделены **PK**.
 
R1(**A**, B, **C**, D, **E**, F, G, H, I)
 
2NF – Удаляем частичные ключевые зависимости.
 
R1(**A**, B), // A -> B \
R2(**A**, **C**, D), // AC->D \
R3(**A**, **C**, **E**, I) // ACE -> I \
R4(**E**, F, G, H) // E ->* FGH
 
3NF – Удаляем транзитивные зависимости.
 
R1(**A**, B), \
R2(**A**, **C**, D), \
R3(**A**, **C**, **E**, I) \
R4(**E**, F, G) // E->G, G->H \
R5(**G**, H)
 
BCNF – Каждый детерминант должен является потенциальным ключом. Для отношений, имеющих один потенциальный ключ, BCNF является 3NF. Рассмотрим отношение R2, т.к. оно имеет более одного ПК - AC или AD. Для отношения R2 справедливы следующие ФЗ:
 
S' = { \
AC -> D, \
D -> C \
}
 
Детерминант в ФЗ D -> C не является ПК отношения R2.
 
R1(**A**, B), \
R3(**A**, **C**, **E**, I) \
R4(**E**, F, G) \
R5(**G**, H), \
R6(**A**, **D**), \
R7(**D**, C)

[^1]: [03 – БД – РМД, нормализация, слайды 33-36](https://disk.yandex.ru/d/7ZGI6YEodZPh7w?w=1)