[К списку вопросов](db_exam.md)

# 16. Безопасность данных в базах данных на примере произвольной СУБД. Поддержка мер обеспечения безопасности в стандарте языка SQL. Директивы GRANT и REVOKE.

Когда в базе данных `PostgreSQL` создаётся объект, ему назначается владелец. Владельцем обычно становится роль, с которой был выполнен оператор создания. Для большинства типов объектов в исходном состоянии только владелец (или суперпользователь) может делать с объектом всё, что угодно.

Чтобы разрешить использовать его другим ролям, нужно дать им права.

Существует несколько типов прав: `SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER, CREATE, CONNECT, TEMPORARY, EXECUTE и USAGE`. 
Набор прав, применимых к определённому объекту, зависит от типа объекта (таблица, функция и т. д.). Более подробно назначение этих прав описывается ниже. Как применяются эти права, вы также увидите в следующих разделах и главах. Неотъемлемое право изменять или удалять объект имеет только владелец объекта.

Объекту можно назначить нового владельца с помощью команды `ALTER` для соответствующего типа объекта, например:
```postgresql
ALTER TABLE имя_таблицы OWNER TO новый_владелец;
```

Суперпользователь может делать это без ограничений, а обычный пользователь — только если он является одновременно текущим владельцем объекта (или членом роли владельца) и членом новой роли.

Для назначения прав применяется команда `GRANT`. Например, если в базе данных есть роль `joe` и таблица `accounts`, право на изменение таблицы можно дать этой роли так:
```postgresql
GRANT UPDATE ON accounts TO joe;
```
Если вместо конкретного права написать `ALL`, роль получит все права, применимые для объекта этого типа. Для назначения права всем ролям в системе можно использовать специальное имя «роли»: `PUBLIC`. Также для упрощения управления ролями, когда в базе данных есть множество пользователей, можно настроить «групповые» роли.

Чтобы лишить пользователей прав, используйте команду `REVOKE`:
```postgresql
REVOKE ALL ON accounts FROM PUBLIC;
```
Особые права владельца объекта (то есть права на выполнение `DROP`, `GRANT`, `REVOKE` и т. д.) всегда неявно закреплены за владельцем и их нельзя назначить или отобрать. Но владелец объекта может лишить себя обычных прав, например, разрешить всем, включая себя, только чтение таблицы.

Обычно распоряжаться правами может только владелец объекта (или суперпользователь). Однако возможно дать право доступа к объекту «с правом передачи», что позволит получившему такое право назначать его другим. Если такое право передачи впоследствии будет отозвано, то все, кто получил данное право доступа (непосредственно или по цепочке передачи), потеряют его.
 
## Команда GRANT
Команда `GRANT` имеет две основные разновидности: первая назначает права для доступа к объектам баз данных (таблицам, столбцам, представлениям, сторонним таблицам, последовательностям, базам данных, обёрткам сторонних данных, сторонним серверам, функциям, процедурам, процедурным языкам, схемам или табличным пространствам), а вторая назначает одни роли членами других. Эти разновидности во многом похожи, но имеют достаточно отличий, чтобы рассматривать их отдельно.
 
**GRANT для объектов баз данных** даёт одной или нескольким ролям определённые права для доступа к объекту базы данных. Эти права добавляются к списку имеющихся, если роль уже наделена какими-то правами. Ключевое слово PUBLIC означает, что права даются всем ролям, включая те, что могут быть созданы позже. PUBLIC можно воспринимать как неявно определённую группу, в которую входят все роли. Любая конкретная роль получит в сумме все права, данные непосредственно ей и ролям, членом которых она является, а также права, данные роли PUBLIC.

Если указано `WITH GRANT OPTION`, получатель права, в свою очередь, может давать его другим. Без этого указания распоряжаться своим правом он не сможет. Группе PUBLIC право передачи права дать нельзя.

Возможные права:
```postgresql
GRANT, SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER, CREATE, CONNECT, TEMPORARY, EXECUTE, USAGE, TEMP, ALL PRIVILEGES
```

**GRANT для ролей** включает роль в члены одной или нескольких других ролей. Членство в ролях играет важную роль, так как права, данные роли, распространяются и на всех её членов.

Получивший членство в роли с указанием `WITH ADMIN OPTION` сможет, в свою очередь, включать в члены этой роли, а также исключать из неё другие роли.

С указанием `GRANTED BY` назначение права сохраняется как данное указанной ролью. Это указание в полной мере могут использовать только суперпользователи базы данных, а обычному пользователю оно доступно, только если в этом указании задаётся имя его роли.

В отличие от прав, членство в ролях нельзя назначить группе `PUBLIC`. Заметьте также, что эта форма команды не принимает избыточное слово `GROUP` в указании роли.

### Примеры
Следующая команда разрешает всем добавлять записи в таблицу films:
```postgresql
GRANT INSERT ON films TO PUBLIC;
```
Эта команда даёт пользователю manuel все права для представления kinds:
```postgresql
GRANT ALL PRIVILEGES ON kinds TO manuel;
```
## Команда REVOKE
Команда `REVOKE` лишает одну или несколько ролей прав, назначенных ранее. Ключевое слово `PUBLIC` обозначает неявно определённую группу всех ролей. Различные типы прав подробно рассматриваются в описании команды `GRANT`.

Следует учитывать, что любая конкретная роль получает в сумме права, данные непосредственно ей, права, данные любой роли, в которую она включена, а также права, данные группе `PUBLIC`. Поэтому, например, лишение `PUBLIC` права `SELECT` не обязательно будет означать, что все роли лишатся права `SELECT` для данного объекта: оно сохранится у тех ролей, которым оно дано непосредственно или косвенно, через другую роль. Подобным образом, лишение права `SELECT` какого-либо пользователя может не повлиять на его возможность пользоваться правом `SELECT`, если это право дано группе `PUBLIC` или другой роли, в которую он включён. Если указано `GRANT OPTION FOR`, отзывается только право передачи права, но не само право. Без этого указания отзывается и право, и право распоряжаться им.

Если пользователь обладает правом с правом передачи и он дал его другим пользователям, последнее право считается зависимым. Когда первый пользователь лишается самого права или права передачи и существуют зависимые права, эти зависимые права также отзываются, если дополнительно указано `CASCADE`; в противном случае операция завершается ошибкой. Это рекурсивное лишение прав затрагивает только права, полученные через цепочку пользователей, которую можно проследить до пользователя, являющегося субъектом команды `REVOKE`. Таким образом, пользователи могут в итоге сохранить это право, если оно было также получено через других пользователей.

Когда отзывается право доступа к таблице, с ним вместе автоматически отзываются соответствующие права для каждого столбца таблицы (если такие права заданы). С другой стороны, если роли были даны права для таблицы, лишение роли таких же прав на уровне отдельных столбцов ни на что не влияет.
 
### Примеры
Лишение группы public права добавлять данные в таблицу films:
```postgresql
REVOKE INSERT ON films FROM PUBLIC;
```
Лишение пользователя manuel всех прав для представления kinds:
```postgresql
REVOKE ALL PRIVILEGES ON kinds FROM manuel;
```
На самом деле это означает «лишить всех прав, которые дал я». Исключение из членов роли admins пользователя joe:
```postgresql
REVOKE admins FROM joe;
```